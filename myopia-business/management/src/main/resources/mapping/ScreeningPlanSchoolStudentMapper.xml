<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wupol.myopia.business.management.domain.mapper.ScreeningPlanSchoolStudentMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.wupol.myopia.business.management.domain.model.ScreeningPlanSchoolStudent">
    </resultMap>
    <resultMap id="SchoolGradeVo" type="com.wupol.myopia.business.management.domain.vo.SchoolGradeVo">
    </resultMap>
    <resultMap id="GradeClassesDTO" type="com.wupol.myopia.business.management.domain.dto.GradeClassesDTO">
    </resultMap>
    <resultMap id="StudentDTO" type="com.wupol.myopia.business.management.domain.dto.StudentDTO">
    </resultMap>


    <!-- 通用查询条件 -->
    <sql id="Base_Where_Clause">
        <where>
            <trim prefixOverrides="and">
                <if test="@Ognl@isNotEmpty(id)">and `id` = #{id}</if>
                <if test="@Ognl@isNotEmpty(screeningPlanId)">and `screening_plan_id` = #{screeningPlanId}</if>
                <if test="@Ognl@isNotEmpty(schoolId)">and `school_id` = #{schoolId}</if>
                <if test="@Ognl@isNotEmpty(districtId)">and `district_id` = #{districtId}</if>
                <if test="@Ognl@isNotEmpty(schoolName)">and `school_name` = #{schoolName}</if>
                <if test="@Ognl@isNotEmpty(gradeId)">and `grade_id` = #{gradeId}</if>
                <if test="@Ognl@isNotEmpty(className)">and `class_name` = #{className}</if>
                <if test="@Ognl@isNotEmpty(screeningOrgId)">and `screening_org_id` = #{screeningOrgId}</if>
                <if test="@Ognl@isNotEmpty(gradeName)">and `grade_name` = #{gradeName}</if>
                <if test="@Ognl@isNotEmpty(classId)">and `class_id` = #{classId}</if>
                <if test="@Ognl@isNotEmpty(studentId)">and `student_id` = #{studentId}</if>
                <if test="@Ognl@isNotEmpty(idCard)">and `id_card` = #{idCard}</if>
                <if test="@Ognl@isNotEmpty(gender)">and `gender` = #{gender}</if>
                <if test="@Ognl@isNotEmpty(birthDate)">and `birth_date` = #{birthDate}</if>
                <if test="@Ognl@isNotEmpty(studentAge)">and `student_age` = #{studentAge}</if>
                <if test="@Ognl@isNotEmpty(studentSituation)">and `student_situation` = #{studentSituation}</if>
                <if test="@Ognl@isNotEmpty(studentNo)">and `student_no` = #{studentNo}</if>
                <if test="@Ognl@isNotEmpty(studentName)">and `student_name` = #{studentName}</if>
                <if test="@Ognl@isNotEmpty(createTime)">and `create_time` = #{createTime}</if>
            </trim>
        </where>
    </sql>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, screening_plan_id,screening_org_id,birth_date,gender, district_id, school_id, school_name, grade_id, gradeName ,class_id, student_id, id_card, student_age, student_situation, student_no, student_name, create_time

    </sql>

    <select id="selectStudentInfoWithResult"
            resultType="com.wupol.myopia.business.management.domain.dto.StudentScreeningInfoWithResultDTO">
        SELECT s.class_id AS clazzId, s.student_name,s.class_name AS clazzName, s.school_name, s.school_id, s.grade_id
        , s.grade_name, s.student_id, s.student_age, s.screening_plan_id, s.student_gender
        , s.task_id, r.biometric_data,r.update_time, r.computer_optometry, r.is_double_screen, r.vision_data
        , r.other_eye_diseases
        FROM m_screening_plan_school_student s
        LEFT JOIN m_vision_screening_result r ON s.id = r.screening_plan_school_student_id
        WHERE
        s.school_id = #{data.schoolId}
        <if test="data.clazzName != null">
            AND s.class_name = #{data.clazzName}
        </if>
        <if test="data.gradeName != null">
            AND s.grade_name = #{data.gradeName}
        </if>
        <if test="data.depId != null">
            AND s.screening_org_id = #{data.depId}
        </if>
    </select>


    <select id="selectSchoolGradeVoByPlanIdAndSchoolId" resultMap="GradeClassesDTO">
        select msg.id as grade_id, msg.name as grade_name, msc.id as class_id, msc.name as class_name from (select grade_id, class_id from m_screening_plan_school_student
        where screening_plan_id = #{screeningPlanId} and school_id = #{schoolId}
        group by grade_id, class_id) grader_class
            left join m_school_grade msg on grader_class.grade_id = msg.id
            left join m_school_class msc on grader_class.class_id = msc.id
    </select>

    <select id="selectPageByQuery" resultMap="StudentDTO" parameterType="java.util.Map">
        SELECT
          ms.id, ms.sno, ms.name, ms.gender, ms.birthday, ms.province_code, ms.city_code, ms.area_code, ms.town_code, ms.address, ms.id_card, ms.nation, ms.parent_phone, msg.name as grade_name, msc.name as class_name
        FROM
        m_screening_plan_school_student mspss
        LEFT JOIN m_student ms ON mspss.student_id = ms.id
        LEFT JOIN m_school_grade msg ON msg.id = mspss.grade_id
        LEFT JOIN m_school_class msc ON msc.id = mspss.class_id
        <where>
            <trim prefixOverrides="and">
                AND mspss.screening_plan_id = #{param.screeningPlanId}
                AND mspss.school_id = #{param.schoolId}
                <if test="param.nameLike != null and param.nameLike != ''">
                    and ms.`name` like CONCAT('%',#{param.nameLike},'%')
                </if>
                <if test="param.idCardLike != null and param.idCardLike != ''">
                    and ms.`id_card` like CONCAT('%',#{param.idCardLike},'%')
                </if>
                <if test="param.snoLike != null and param.snoLike != ''">
                    and ms.`sno` like CONCAT('%',#{param.snoLike},'%')
                </if>
                <if test="param.phoneLike != null and param.phoneLike != ''">
                    and ms.`parent_phone` like CONCAT('%',#{param.phoneLike},'%')
                </if>
                <if test="param.gender != null and param.gender != ''">
                    and ms.`gender` = #{param.gender}
                </if>
                <if test="param.gradeList != null">
                    and mspss.`grade_id` in <foreach collection="param.gradeList" open="(" close=")" separator="," item="item">#{item}</foreach>
                </if>
            </trim>
        </where>
    </select>

    <select id="selectByIdCards" resultMap="BaseResultMap" parameterType="java.util.Map">
        select *
        from m_screening_plan_school_student
        where screening_plan_id = #{screeningPlanId} and school_id = #{schoolId}
        and id_card in <foreach collection="idCards" open="(" close=")" separator="," item="item">#{item}</foreach>
    </select>

    <select id="selectByGradeAndClass" resultMap="StudentDTO" parameterType="java.util.Map">
        select mspss.student_name as name, mspss.student_no as sno, ms.gender
        from m_screening_plan_school_student mspss
        left join m_student ms on mspss.student_id = ms.id
        where mspss.screening_plan_id = #{screeningPlanId} and mspss.grade_id = #{gradeId} and mspss.class_id = #{classId}
    </select>
</mapper>
